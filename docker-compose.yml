version: '3.8'

x-php-base: &php-base
  build:
    context: ./docker/php
    dockerfile: Dockerfile
  volumes:
    - ./app:/var/www/html
  environment:
    DB_HOST: ${DB_HOST}
    DB_NAME: ${DB_NAME}
    DB_USER: ${DB_USER}
    DB_PASSWORD: ${DB_PASSWORD}
    SMSPILOT_API_KEY: ${SMSPILOT_API_KEY}
    RABBITMQ_HOST: ${RABBITMQ_HOST}
    RABBITMQ_PORT: ${RABBITMQ_PORT}
    RABBITMQ_USER: ${RABBITMQ_USER}
    RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
  depends_on:
    - mysql
    - rabbitmq
  networks:
    - book-catalog-network

services:
  nginx:
    image: nginx:alpine
    container_name: book-catalog-nginx
    ports:
      - "8080:80"
    volumes:
      - ./app:/var/www/html
      - ./app/vendor:/var/www/vendor
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - php
    networks:
      - book-catalog-network

  php:
    <<: *php-base
    container_name: book-catalog-php

  worker:
    <<: *php-base
    container_name: book-catalog-worker
    command: ["php", "/var/www/html/protected/yiic.php", "worker", "run"]
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: book-catalog-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - book-catalog-network

  mysql:
    image: mysql:8.0
    container_name: book-catalog-mysql
    ports:
      - "33063:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - book-catalog-network

networks:
  book-catalog-network:
    driver: bridge

volumes:
  mysql-data:
  rabbitmq-data: